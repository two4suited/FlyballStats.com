# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
- stage:
  jobs:
  - job: infrastructure
    displayName: Preview/Deploy Infrastrucutre
    steps:        
    - task: Pulumi@1
      displayName: Deploy Infrastructure
      inputs:
        azureSubscription: 'Pay-As-You-Go(3bd10068-0c35-4ed1-8436-1b052ac96a2b)'
        command: 'up'
        args: '--skip-preview'
        cwd: 'infra/'
        stack: 'two4suited/flyballstats.com/dev'
      env:
        PULUMI_ACCESS_TOKEN: $(pulumi_access_token)
  - job: run_tests
    displayName: Run Unit Tests
    dependsOn: infrastructure
    steps:
    - task: DotNetCoreCLI@2
      displayName: Run XUnit Tests
      inputs:
        command: 'test'
        projects: '**/*tests.csproj'
        testRunTitle: 'Run Unit Tests'
  - job: code
    displayName: Deploy
    dependsOn: run_tests
    steps:
    - task: AzureStaticWebApp@0
      inputs:
        app_location: 'web'
        api_location: 'api'
        production_branch: 'main'
        azure_static_web_apps_api_token: $(deployment_token)

  
